(()=>{"use strict";var e,t={591:()=>{const e=Vue.resource("api/v1/storage-requests{/id}/directories"),t=Vue.resource("api/v1/storage-requests{/id}/files"),i=Vue.resource("api/v1/storage-requests{/id}",{},{approve:{method:"POST",url:"api/v1/storage-requests{/id}/approve"},reject:{method:"POST",url:"api/v1/storage-requests{/id}/reject"},extend:{method:"POST",url:"api/v1/storage-requests{/id}/extend"}});var s=biigle.$require("core.components.fileBrowser"),r=biigle.$require("messages").handleErrorResponse,n=biigle.$require("core.mixins.loader"),o=function(e){var t="",i=["kB","MB","GB","TB"];do{e/=1e3,t=i.shift()}while(e>1e3&&i.length>0);return"".concat(e.toFixed(2)," ").concat(t)},a=function(e){var t={name:"",directories:{},files:[]};return e.files&&e.files.forEach((function(e){var i=e.split("/"),s=i.pop(),r=t;i.forEach((function(e){r.directories.hasOwnProperty(e)||(r.directories[e]={name:e,directories:{},files:[]}),r=r.directories[e]})),r.files.push({name:s})})),t};function l(e,t,i,s,r,n,o,a){var l,u="function"==typeof e?e.options:e;if(t&&(u.render=t,u.staticRenderFns=i,u._compiled=!0),s&&(u.functional=!0),n&&(u._scopeId="data-v-"+n),o?(l=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),r&&r.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(o)},u._ssrRegister=l):r&&(l=a?function(){r.call(this,(u.functional?this.parent:this).$root.$options.shadowRoot)}:r),l)if(u.functional){u._injectStyles=l;var d=u.render;u.render=function(e,t){return l.call(t),d(e,t)}}else{var c=u.beforeCreate;u.beforeCreate=c?[].concat(c,l):[l]}return{exports:e,options:u}}const u=l({mixins:[n],components:{fileBrowser:s},data:function(){return{currentUploadedSize:0,files:[],finished:!1,finishedUploadedSize:0,loadedUnfinishedRequest:!1,maxSize:-1,rootDirectory:{name:"",directories:{},files:[],selected:!1},selectedDirectory:null,storageRequest:null,usedQuotaBytes:0,availableQuotaBytes:0,maxFilesizeBytes:0,exceedsMaxFilesize:!1}},computed:{hasSelectedDirectory:function(){return null!==this.selectedDirectory},selectedDirectoryName:function(){return this.selectedDirectory.name},hasFiles:function(){return this.files.length>0},totalSize:function(){return this.files.reduce((function(e,t){return e+t.size}),0)},totalSizeForHumans:function(){return o(this.totalSize)},uploadedSize:function(){return this.currentUploadedSize+this.finishedUploadedSize},uploadedPercent:function(){return Math.round(this.uploadedSize/this.totalSize*100)},uploadedSizeForHumans:function(){return o(this.uploadedSize)},editable:function(){return!this.loading&&!this.finished},exceedsMaxSize:function(){return-1!==this.availableQuotaBytes&&this.totalSize>this.availableQuotaBytes},canSubmit:function(){return this.hasFiles&&!this.exceedsMaxSize},usedQuota:function(){return o(this.usedQuotaBytes)},availableQuota:function(){return o(this.availableQuotaBytes)},usedQuotaPercent:function(){return Math.round(this.usedQuotaBytes/this.availableQuotaBytes*100)},maxFilesize:function(){return o(this.maxFilesizeBytes)}},methods:{handleFilesChosen:function(e){var t=this;if(this.hasSelectedDirectory){var i=Array.from(e.target.files).filter((function(e){return e.size<=t.maxFilesizeBytes}));i.length<e.target.files.length&&(this.exceedsMaxFilesize=!0);var s=this.selectedDirectory.files,r=0,n=[];for(r=0;r<i.length;r++)n.push(i[r].name);for(r=s.length;r--;)n.includes(s[r].name)&&s.splice(r,1);for(r=0;r<i.length;r++)s.push(i[r]);this.syncFiles()}},getNewDirectory:function(e){return{name:e,directories:{},files:[],selected:!1}},handleNewDirectory:function(e,t){var i,s=this,r=this.rootDirectory.directories;this.hasSelectedDirectory&&(t||(r=this.selectedDirectory.directories),this.selectedDirectory.selected=!1),e.split("/").forEach((function(e){r.hasOwnProperty(e)||(i=Vue.set(r,e,s.getNewDirectory(e))),r=r[e].directories})),i.selected=!0,this.selectedDirectory=i},addDirectory:function(e){var t=prompt("Please enter the new directory name");t&&this.handleNewDirectory(t,!0===e)},addRootDirectory:function(){this.addDirectory(!0)},addFiles:function(){this.$refs.fileInput.click()},selectDirectory:function(e){this.hasSelectedDirectory&&(this.selectedDirectory.selected=!1),this.selectedDirectory=e,this.selectedDirectory.selected=!0},unselectDirectory:function(){this.hasSelectedDirectory&&(this.selectedDirectory.selected=!1,this.selectedDirectory=null)},removeDirectory:function(t,i){var s=this;i=i.slice(1);var n=this.rootDirectory.directories;i.split("/").slice(0,-1).forEach((function(e){n=n[e].directories})),(n[t.name].saved?e.delete({id:this.storageRequest.id},{directories:[i]}):Vue.Promise.resolve()).then((function(){Vue.delete(n,t.name),s.hasSelectedSubdirectory(t)&&(s.selectedDirectory=null),s.syncFiles()}),r)},hasSelectedSubdirectory:function(e){var t=this;return Object.keys(e.directories).reduce((function(i,s){return i||t.hasSelectedSubdirectory(e.directories[s])}),e.selected)},removeFile:function(e,i){i=i.slice(1);var s=this.rootDirectory;i.split("/").forEach((function(e){s=s.directories[e]}));var n,o=s.files;if(e.saved){var a=["".concat(i,"/").concat(e.name)];n=t.delete({id:this.storageRequest.id},{files:a})}else n=Vue.Promise.resolve();n.then((function(){var t=o.indexOf(e);-1!==t&&o.splice(t,1),this.syncFiles()}),r)},extractFiles:function(e,t){t=t?"".concat(t,"/").concat(e.name):e.name;var i=[];for(var s in e.directories)i=i.concat(this.extractFiles(e.directories[s],t));return i.concat(e.files.map((function(i){return{prefix:t,size:i.size,file:i,directory:e}})))},syncFiles:function(){this.files=this.extractFiles(this.rootDirectory)},handleSubmit:function(){this.canSubmit&&(this.startLoading(),(this.storageRequest?Promise.resolve({body:this.storageRequest}):i.save()).then(this.proceedWithUpload).then(this.finishSubmission).catch(r).finally(this.finishLoading))},proceedWithUpload:function(e){return this.storageRequest=e.body,this.uploadAllFiles()},uploadAllFiles:function(){var e=this,t=this.files.filter((function(e){return!0!==e.file.saved}));return function i(){if(0!==t.length)return e.uploadFile(t.shift()).then(i)}()},uploadFile:function(e){var t=this,i="api/v1/storage-requests/".concat(this.storageRequest.id,"/files"),s=new FormData;return s.append("file",e.file),s.append("prefix",e.prefix),this.$http.post(i,s,{uploadProgress:this.updateCurrentUploadedSize}).then((function(){t.currentUploadedSize=0,t.finishedUploadedSize+=e.file.size,e.file.saved=!0,e.directory.saved=!0}))},updateCurrentUploadedSize:function(e){e.lengthComputable&&(this.currentUploadedSize=e.loaded)},finishSubmission:function(){var e=this;return i.update({id:this.storageRequest.id},{}).then((function(){return e.finished=!0}))},addExistingFiles:function(e){e.forEach(this.addExistingFile),this.syncFiles()},addExistingFile:function(e){var t=this,i=e.split("/"),s=i.pop(),r=this.rootDirectory;i.forEach((function(e){r.directories.hasOwnProperty(e)||Vue.set(r.directories,e,t.getNewDirectory(e)),(r=r.directories[e]).saved=!0})),r.files.push({saved:!0,name:s,size:0})}},created:function(){var e=this;this.usedQuotaBytes=biigle.$require("user-storage.usedQuota"),this.availableQuotaBytes=biigle.$require("user-storage.availableQuota"),this.maxFilesizeBytes=biigle.$require("user-storage.maxFilesize"),this.storageRequest=biigle.$require("user-storage.previousRequest"),this.storageRequest&&this.storageRequest.files.length>0&&(this.addExistingFiles(this.storageRequest.files),this.loadedUnfinishedRequest=!0),window.addEventListener("beforeunload",(function(t){if(e.loading)return t.preventDefault(),t.returnValue="","This page is asking you to confirm that you want to leave - the file upload is still in progress."}))}},undefined,undefined,!1,null,null,null).exports;var d=l({props:{request:{type:Object,required:!0},expireDate:{type:Date,default:null},selected:{type:Boolean,default:!1}},computed:{pending:function(){return!this.request.expires_at},expired:function(){return Date.parse(this.request.expires_at)<Date.now()},expiresSoon:function(){return!(!this.request.expires_at||!this.expireDate)&&Date.parse(this.request.expires_at)<this.expireDate.getTime()},expiresTitle:function(){return"Expires ".concat(this.request.expires_at_for_humans)},filesCount:function(){return this.request.files?this.request.files.length:this.request.files_count||0},classObject:function(){return{active:this.selected}}},methods:{handleSelect:function(){this.$emit("select",this.request)},handleDelete:function(){this.$emit("delete",this.request)},handleExtend:function(){this.expiresSoon&&this.$emit("extend",this.request)}}},(function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("a",{staticClass:"list-group-item",class:e.classObject,attrs:{href:"#"},on:{click:function(t){return t.preventDefault(),e.handleSelect.apply(null,arguments)}}},[e._v("\n    #"),i("span",{domProps:{textContent:e._s(e.request.id)}}),e._v(" created "),i("span",{domProps:{textContent:e._s(e.request.created_at_for_humans)}}),e._v(" with "),i("span",{domProps:{textContent:e._s(e.request.files_count)}}),e._v(" file(s).\n    "),e.pending?i("span",[i("span",{staticClass:"label label-default",attrs:{title:"Waiting for review"}},[e._v("pending")])]):i("span",[e.expired?i("span",[i("span",{staticClass:"label label-danger",attrs:{title:"The storage request is expired and will be deleted soon"}},[e._v("expired")])]):i("span",[e.expiresSoon?i("span",{staticClass:"label label-warning",attrs:{title:e.expiresTitle}},[e._v("\n                expires "),i("span",{domProps:{textContent:e._s(this.request.expires_at_for_humans)}})]):i("span",{staticClass:"label label-success",attrs:{title:e.expiresTitle}},[e._v("\n                approved\n            ")])])]),e._v(" "),i("span",{staticClass:"pull-right"},[i("button",{staticClass:"btn btn-default btn-xs delete-button",attrs:{title:"Delete this storage request"},on:{click:function(t){return t.preventDefault(),e.handleDelete.apply(null,arguments)}}},[i("i",{staticClass:"fa fa-trash"})]),e._v(" "),e.expiresSoon?i("button",{staticClass:"btn btn-default btn-xs",attrs:{title:"Extend this storage request"},on:{click:function(t){return t.preventDefault(),e.handleExtend.apply(null,arguments)}}},[i("i",{staticClass:"fa fa-redo"})]):e._e()])])}),[],!1,null,null,null);var c=l({components:{listItem:d.exports},props:{requests:{type:Array,required:!0},expireDate:{type:Date,default:null},selectedRequest:{type:Object,default:null}},computed:{noItems:function(){return 0===this.requests.length}},methods:{emitDelete:function(e){this.$emit("delete",e)},emitExtend:function(e){this.$emit("extend",e)},emitSelect:function(e){this.$emit("select",e)},isSelectedRequest:function(e){return!!this.selectedRequest&&this.selectedRequest.id===e.id}}},(function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"list-group storage-request-list"},[e._l(e.requests,(function(t){return i("list-item",{key:t.id,attrs:{request:t,"expire-date":e.expireDate,selected:e.isSelectedRequest(t)},on:{select:e.emitSelect,delete:e.emitDelete,extend:e.emitExtend}})})),e._v(" "),e.noItems?i("span",{staticClass:"list-group-item text-muted"},[e._v("\n        no storage requests\n    ")]):e._e()],2)}),[],!1,null,null,null);const h=l({mixins:[n],components:{requestList:c.exports,fileBrowser:s},data:function(){return{requests:[],expireDate:0,usedQuotaBytes:0,availableQuotaBytes:0,selectedRequest:null,itemDeleted:!1}},computed:{usedQuota:function(){return o(this.usedQuotaBytes)},availableQuota:function(){return o(this.availableQuotaBytes)},usedQuotaPercent:function(){return Math.round(this.usedQuotaBytes/this.availableQuotaBytes*100)},hasSelectedRequest:function(){return null!==this.selectedRequest},selectedRequestRoot:function(){return a(this.selectedRequest)}},methods:{handleSelectRequest:function(e){this.loading||(e.files?this.selectedRequest=e:(this.startLoading(),i.get({id:e.id}).then(this.setFilesAndSelectRequest,r).finally(this.finishLoading)))},setFilesAndSelectRequest:function(e){var t=this.requests.find((function(t){return t.id===e.body.id}));Vue.set(t,"files",e.body.files),t.files_count=e.body.files_count,this.selectedRequest=t},handleDeleteRequest:function(e){var t=this;this.loading||confirm("Do you really want to delete the storage request with all files?")&&(this.startLoading(),i.delete({id:e.id},{}).then((function(){return t.handleRequestDeleted(e)}),r).finally(this.finishLoading))},handleRequestDeleted:function(e){var t=this.requests.indexOf(e);-1!==t&&this.requests.splice(t,1),this.selectedRequest&&this.selectedRequest.id===e.id&&(this.selectedRequest=null),this.itemDeleted=!0},handleExtendRequest:function(e){this.loading||(this.startLoading(),i.extend({id:e.id},{}).then(this.handleRequestExtended,r).finally(this.finishLoading))},handleRequestExtended:function(e){var t=this.requests.find((function(t){return t.id===e.body.id}));t.expires_at=e.body.expires_at,t.expires_at_for_humans=e.body.expires_at_for_humans},removeDirectory:function(t,i){var s=this;this.loading||confirm("Do you really want to delete the directory with all files?")&&(this.startLoading(),i=i.slice(1),e.delete({id:this.selectedRequest.id},{directories:[i]}).then((function(){return s.directoryRemoved(i)}),r).finally(this.finishLoading))},directoryRemoved:function(e){this.selectedRequest.files=this.selectedRequest.files.filter((function(t){return!t.startsWith(e+"/")})),this.selectedRequest.files_count=this.selectedRequest.files.length,this.itemDeleted=!0},removeFile:function(e,i){var s=this;this.loading||confirm("Do you really want to delete the file?")&&(this.startLoading(),i="".concat(i.slice(1),"/").concat(e.name),t.delete({id:this.selectedRequest.id},{files:[i]}).then((function(){return s.fileRemoved(i)}),r).finally(this.finishLoading))},fileRemoved:function(e){var t=this.selectedRequest.files.indexOf(e);-1!==t&&(this.selectedRequest.files.splice(t,1),this.selectedRequest.files_count-=1),this.itemDeleted=!0}},created:function(){this.requests=biigle.$require("user-storage.requests"),this.expireDate=new Date(biigle.$require("user-storage.expireDate")),this.usedQuotaBytes=biigle.$require("user-storage.usedQuota"),this.availableQuotaBytes=biigle.$require("user-storage.availableQuota")}},undefined,undefined,!1,null,null,null).exports;const f=l({mixins:[n],components:{fileBrowser:s},data:function(){return{request:null,rejecting:!1,rejectReason:"",approved:!1,rejected:!1}},computed:{requestRoot:function(){return a(this.request)},cannotReject:function(){return this.loading||!this.rejectReason},finished:function(){return this.approved||this.rejected}},methods:{handleApprove:function(){this.startLoading(),i.approve({id:this.request.id},{}).then(this.handleApproved,r).finally(this.finishLoading)},handleApproved:function(){this.approved=!0},handleRejecting:function(){this.rejecting=!0},handleCancelReject:function(){this.rejecting=!1,this.rejectReason=""},handleReject:function(){this.startLoading(),i.reject({id:this.request.id},{reason:this.rejectReason}).then(this.handleRejected,r).finally(this.finishLoading)},handleRejected:function(){this.rejected=!0}},created:function(){this.request=biigle.$require("user-storage.request")}},undefined,undefined,!1,null,null,null).exports;biigle.$mount("create-storage-request-container",u),biigle.$mount("index-storage-request-container",h),biigle.$mount("review-storage-request-container",f)},401:()=>{}},i={};function s(e){var r=i[e];if(void 0!==r)return r.exports;var n=i[e]={exports:{}};return t[e](n,n.exports,s),n.exports}s.m=t,e=[],s.O=(t,i,r,n)=>{if(!i){var o=1/0;for(d=0;d<e.length;d++){for(var[i,r,n]=e[d],a=!0,l=0;l<i.length;l++)(!1&n||o>=n)&&Object.keys(s.O).every((e=>s.O[e](i[l])))?i.splice(l--,1):(a=!1,n<o&&(o=n));if(a){e.splice(d--,1);var u=r();void 0!==u&&(t=u)}}return t}n=n||0;for(var d=e.length;d>0&&e[d-1][2]>n;d--)e[d]=e[d-1];e[d]=[i,r,n]},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={355:0,392:0};s.O.j=t=>0===e[t];var t=(t,i)=>{var r,n,[o,a,l]=i,u=0;if(o.some((t=>0!==e[t]))){for(r in a)s.o(a,r)&&(s.m[r]=a[r]);if(l)var d=l(s)}for(t&&t(i);u<o.length;u++)n=o[u],s.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return s.O(d)},i=self.webpackChunkbiigle_user_storage=self.webpackChunkbiigle_user_storage||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})(),s.O(void 0,[392],(()=>s(591)));var r=s.O(void 0,[392],(()=>s(401)));r=s.O(r)})();